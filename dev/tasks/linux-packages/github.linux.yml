# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

{% import 'macros.jinja' as macros with context %}

{{ macros.github_header() }}

jobs:
  package:
    name: Package
    {% if architecture == "amd64" %}
    runs-on: ubuntu-22.04
    {% else %}
    runs-on: ["self-hosted", "Linux", "arm64"]
    {% endif %}
    env:
      ARCHITECTURE: {{ architecture }}
    steps:
      {{ macros.github_checkout_arrow()|indent }}
      {{ macros.github_login_dockerhub()|indent }}

      - name: Free up disk space
        if: |
          env.ARCHITECTURE == 'amd64'
        run: |
          du -hsc /usr/local/share/*
          du -hs /usr/local/bin
          df -h
          du -hsc /opt/* /usr/local/*
          du -hsc /opt/hostedtoolcache/*
          # ~1GB (From 1.2GB to 214MB)
          sudo rm  -rf /usr/local/bin/aliyun \
                /usr/local/bin/azcopy \
                /usr/local/bin/bicep \
                /usr/local/bin/cmake-gui \
                /usr/local/bin/cpack \
                /usr/local/bin/helm \
                /usr/local/bin/hub \
                /usr/local/bin/kubectl \
                /usr/local/bin/minikube \
                /usr/local/bin/node \
                /usr/local/bin/packer \
                /usr/local/bin/pulumi* \
                /usr/local/bin/stack \
                /usr/local/bin/terraform
          du -hs /usr/local/bin
          # 5.3GB
          sudo rm -rf /opt/hostedtoolcache/CodeQL || :
          # 1.4GB
          sudo rm -rf /opt/hostedtoolcache/go || :
          # 489MB
          sudo rm -rf /opt/hostedtoolcache/PyPy || :
          # 1.2GB
          sudo rm -rf /opt/hostedtoolcache/Python || :
          # 376MB
          sudo rm -rf /opt/hostedtoolcache/node || :
          df -h
