#!/bin/bash
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
set -e

release_version=$1
release_hash=$2

release_tag=apache-arrow-$release_version
release_tarball=${release_tag}.tar.gz

# be conservative and use the release hash, even though git produces the same
# archive (identical hashes) using the scm tag
pushd /arrow
  git archive ${release_hash} --output /git_release_archive.tar
popd

# extract to a temporary directory to build c_glib distribution
mkdir -p /release
tar -xf /git_release_archive.tar -C /release

# build Apache Arrow C++ before building Apache Arrow GLib because
# Apache Arrow GLib requires Apache Arrow C++.
mkdir -p /release/cpp/build

cpp_install_dir=/release/cpp/install

pushd /release/cpp/build
  cmake .. \
    -DCMAKE_INSTALL_PREFIX=${cpp_install_dir} \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DARROW_BUILD_TESTS=no \
    -DARROW_PARQUET=yes
  make -j8
  make install
popd

# build source archive for Apache Arrow GLib by "make dist".
pushd /release/c_glib
  ./autogen.sh
  ./configure \
    PKG_CONFIG_PATH=$cpp_install_dir/lib/pkgconfig \
    --enable-gtk-doc

  LD_LIBRARY_PATH=$cpp_install_dir/lib:$LD_LIBRARY_PATH make -j8
  make dist
popd

mkdir -p /tmp/c_glib
mv /release/c_glib/*.tar.gz /tmp/c_glib

pushd /tmp/c_glib
  tar xzf *.tar.gz
  rm *.tar.gz
popd

# replace c_glib/ by tar.gz generated by "make dist"
mkdir -p /${release_tag}
tar -xf /git_release_archive.tar -C /${release_tag}
rm -rf /${release_tag}/c_glib
mv /tmp/c_glib /${release_tag}/c_glib

# Create new tarball from modified source directory
tar czhf /arrow/${release_tarball} /${release_tag}
