# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: MATLAB CI to Build and Run Tests

on: 
  push:
    paths:
      - '.github/workflows/matlab.yml'
      - 'ci/scripts/matlab*.sh'
      - 'matlab/**'
      
concurrency:
  group: ${{ github.repository }}-${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  DOCKER_VOLUME_PREFIX: ".docker/"
  ARCHERY_DOCKER_USER: ${{ secrets.DOCKERHUB_USER }}
  ARCHERY_DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
    debian:
        name: Build cpp api and run MATLAB Tests
        runs-on: ubuntu-latest
        env:
            ARROW_HOME: /usr/local/
        steps:
          - name: Check out repository
            uses: actions/checkout@v2
            with:
                fetch-depth: 0
          - name: Fetch Submodules and Tags
            shell: bash
            run: ci/scripts/util_checkout.sh
          - name: Build MATLAB
            shell: bash
            run: |
                ci/scripts/cpp_build.sh $(pwd) $(pwd)/build
                ci/scripts/matlab_build.sh $(pwd) $(pwd)/build
            
    my-job:
        name: Run MATLAB Tests and Generate Artifacts
        runs-on: ubuntu-latest
        steps:
          - name: Check out repository
            uses: actions/checkout@v2
          - name: Install MATLAB
            uses: matlab-actions/setup-matlab@v0
          - name: Run script
            uses: matlab-actions/run-command@v0
            with:
                command: cd(fullfile('matlab','build_support'));compile
          - name: Run tests and generate artifacts
            uses: matlab-actions/run-tests@v0