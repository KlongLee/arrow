# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Package

on:
  push:
    tags:
      - "apache-arrow-*-rc*"

jobs:
  release:
    name: Release Candidate
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Check out repository 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Update tags
        run: |
          git fetch --tags --force origin
      - name: Store release tag name as environment variable
        run: |
          echo "RELEASE_TAG_NAME=${{github.ref_name}}" >> "$GITHUB_ENV"
      - name: Prepare Version
        # Extract the version string, version with the release-candidate
        # number string, and release-candidate number from the git tag name
        # (i.e. RELEASE_TAG_NAME). Store extracted values as environment
        # variables in GITHUB_ENV for use in subsequent steps. 
        run: |
          version_with_rc=${RELEASE_TAG_NAME#apache-arrow-}
          version=${version_with_rc%-rc*}
          rc=${version_with_rc#${version}-rc}
          echo "ARROW_VERSION_WITH_RC=$version_with_rc" >> "$GITHUB_ENV"
          echo "ARROW_VERSION=$version" >> $GITHUB_ENV
          echo "ARROW_RC=$rc" >> $GITHUB_ENV
      - name: Extract crossbow job id
        # Extract the crossbow job ID from the subject associated with the git
        # tag message. Store the extracted ID as an environment variable in 
        # GITHUB_ENV for use in subsequent steps. 
        run: |
          crossbow_job_id=$(git for-each-ref refs/tags/$RELEASE_TAG_NAME --format='%(contents:subject)')
          echo "CROSSBOW_JOB_ID=$crossbow_job_id" >> "$GITHUB_ENV"
      - name: Setup Archery
        run: |
          python3 -m pip install -e dev/archery[crossbow]
      - name: Download artifacts
        # Download the MLTBX file associated with the crossbow job ID.
        # Store the path to the downloaded file as an environment variable
        # in GITHUB_ENV for use in subsequent steps. 
        run: |
          archery crossbow download-artifacts -f matlab -t release-artifacts $CROSSBOW_JOB_ID
          basefilename=$(find release-artifacts/$CROSSBOW_JOB_ID -name '*.mltbx' -type f | xargs basename)
          mltbx_file=release-artifacts/$CROSSBOW_JOB_ID/$basefilename
          echo "ARROW_MLTBX_FILE=$mltbx_file" >> $GITHUB_ENV
      - name: Cut Pre-Release
        run: |
          target_branch=release-$ARROW_VERSION_WITH_RC
          title="Apache Arrow $ARROW_VERSION RC$ARROW_RC"
          repository=${{github.repository}}
          release_notes="Release Candidate: $ARROW_VERSION RC$ARROW_RC"
          gh release create \
            $RELEASE_TAG_NAME \
            $ARROW_MLTBX_FILE \
            --prerelease \
            --target $target_branch \
            --notes "$release_notes" \
            --title "$title" \
            --repo $repository

